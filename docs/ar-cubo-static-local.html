<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AR – Cubo (local-friendly + debug)</title>
  <style>
    html,body { margin:0; height:100%; }
    body { font-family:system-ui, Segoe UI, Roboto, Arial; background:#f2f2f2; }
    header { position:fixed; left:0; right:0; top:0; background:#fff; border-bottom:1px solid #e5e5e5; padding:8px 12px; display:flex; gap:8px; align-items:center; z-index:10; }
    header h1 { margin:0; font-size:14px; font-weight:700; }
    header .spacer { flex:1 }
    #mvWrap { position:fixed; inset:42px 0 140px 0; background:#e9eef5; }
    model-viewer { width:100%; height:100%; background-color:#e9eef5; --poster-color:#e9eef5; }
    footer { position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid #e5e5e5; padding:8px 12px; }
    #log { white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; font-size:12px; line-height:1.3; color:#222; max-height:120px; overflow:auto; }
    button { appearance:none; border:1px solid #ddd; background:#fafafa; padding:6px 10px; border-radius:10px; cursor:pointer; font-weight:600; }
  </style>
  <script type="module" src="https://cdn.jsdelivr.net/npm/@google/model-viewer@4.0.0/dist/model-viewer.min.js"></script>
</head>
<body>
  <header>
    <h1>AR – Cubo (local-friendly)</h1>
    <div class="spacer"></div>
    <button id="btnReset">Reset view</button>
    <button id="btnAR">Abrir AR</button>
  </header>

  <div id="mvWrap">
    <model-viewer id="mv"
      src="https://raw.githubusercontent.com/KhronosGroup/glTF-Sample-Models/master/2.0/Box/glTF-Binary/Box.glb"
      alt="Cubo de amostra (Khronos)"
      camera-controls
      ar ar-modes="webxr scene-viewer"
      shadow-intensity="0.6"
      exposure="0.9"
      environment-image="neutral"
      camera-orbit="0deg 65deg 2m"
      camera-target="0m 0m 0m"
      field-of-view="40deg"
      min-field-of-view="20deg"
      max-field-of-view="60deg"
      interaction-prompt="none"
      auto-rotate>
    </model-viewer>
  </div>

  <footer>
    <div id="log"></div>
  </footer>

  <script type="module">
    const mv = document.getElementById('mv');
    const btnReset = document.getElementById('btnReset');
    const btnAR = document.getElementById('btnAR');
    const logEl = document.getElementById('log');

    function log(...args){
      console.log(...args);
      try { logEl.textContent += args.map(a => (typeof a==='object'? JSON.stringify(a) : String(a))).join(' ') + "\\n"; } catch(e){}
      logEl.scrollTop = logEl.scrollHeight;
    }

    async function printState(prefix=''){
      const orbit = mv.getCameraOrbit ? mv.getCameraOrbit() : null;
      const target = mv.getCameraTarget ? mv.getCameraTarget() : null;
      log(prefix + 'orbit=', orbit ? `${orbit.theta.toFixed(2)} ${orbit.phi.toFixed(2)} ${orbit.radius.toFixed(2)}` : 'n/a',
          ' target=', target ? `${target.x.toFixed(2)} ${target.y.toFixed(2)} ${target.z.toFixed(2)}` : 'n/a',
          ' fov=', mv.fieldOfView || 'n/a');
    }

    log('UA:', navigator.userAgent);
    log('src:', mv.getAttribute('src'));

    mv.addEventListener('load', async () => {
      log('model-viewer: load (modelo carregado).');
      await printState('[load] ');

      // Bounding box (aproximado)
      try {
        const dims = mv.getDimensions ? mv.getDimensions() : null;
        if (dims) log('dimensions:', JSON.stringify(dims));
      } catch(e){ log('getDimensions error:', String(e)); }
    });

    mv.addEventListener('ar-status', (e) => log('ar-status:', e.detail.status));
    mv.addEventListener('error', (e) => log('error:', e.message || JSON.stringify(e)));

    btnReset.addEventListener('click', async () => {
      mv.cameraOrbit = '0deg 65deg 2m';
      mv.cameraTarget = '0m 0m 0m';
      mv.fieldOfView = '40deg';
      await mv.updateComplete;
      await printState('[reset] ');
    });

    btnAR.addEventListener('click', () => {
      if (mv.activateAR) mv.activateAR();
      else log('activateAR não disponível.');
    });

    // Diagnóstico de rede
    (async () => {
      const url = mv.getAttribute('src');
      log('HEAD →', url);
      try {
        const head = await fetch(url, { method:'HEAD' });
        log('HEAD status:', head.status, head.statusText, 'len:', head.headers.get('content-length'));
      } catch (err) { log('HEAD falhou:', String(err)); }
    })();
  </script>
</body>
</html>
